#!/bin/bash

# –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è Telegram WebApp
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –ø–æ–ª—å–∑—É –Ω–∞—à–µ–π –≤–µ—Ä—Å–∏–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-advanced.sh [commit_message]

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ –ó–∞–ø—É—Å–∫ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è Telegram WebApp${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "docker-compose.yml" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞.${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Git
if [ -z "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞${NC}"
    exit 0
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
COMMIT_MESSAGE=${1:-"Auto deploy: $(date '+%Y-%m-%d %H:%M:%S')"}

echo -e "${BLUE}üìù –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${COMMIT_MESSAGE}${NC}"

# –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${BLUE}üì¶ –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git...${NC}"
git add .

# –î–µ–ª–∞–µ–º –∫–æ–º–º–∏—Ç
echo -e "${BLUE}üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç...${NC}"
git commit -m "$COMMIT_MESSAGE"

# –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${BLUE}üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä...${NC}"
git push origin main

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo -e "${BLUE}üñ•Ô∏è  –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...${NC}"
ssh root@217.114.13.102 << 'EOF'
    echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
    cd /opt/telegram-webapp
    
    echo "üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git stash
    
    echo "üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git pull origin main || {
        echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Ä–∞–∑—Ä–µ—à–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏..."
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
        CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
        
        if [ -n "$CONFLICT_FILES" ]; then
            echo "üîß –†–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ —Ñ–∞–π–ª–∞—Ö: $CONFLICT_FILES"
            
            # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É –≤–µ—Ä—Å–∏—é
            for file in $CONFLICT_FILES; do
                echo "   –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É –≤–µ—Ä—Å–∏—é –¥–ª—è: $file"
                git checkout --ours "$file"
                git add "$file"
            done
            
            echo "üíæ –ö–æ–º–º–∏—Ç–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã..."
            git commit -m "Auto-resolve conflicts: use our version"
        fi
    }
    
    echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git stash pop || true
    
    echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º frontend..."
    docker-compose build --no-cache frontend
    
    echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º frontend..."
    docker-compose up -d frontend
    
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
    docker-compose ps | grep frontend
    
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö Docker –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
    echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ Docker –æ–±—Ä–∞–∑—ã..."
    docker system prune -f --volumes

    echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
EOF

echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
echo -e "${BLUE}üåê WebApp –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://app.daniillepekhin.ru${NC}"
echo -e "${YELLOW}üí° –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤: ssh root@217.114.13.102 'cd /opt/telegram-webapp && docker-compose logs -f frontend'${NC}" 